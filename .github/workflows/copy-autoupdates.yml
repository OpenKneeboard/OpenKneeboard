name: Publish to OpenKneeboard/autoupdates repository
on:
  push:
    branches:
      - master
    paths:
      - autoupdate/**
  workflow_dispatch:
# If this job is already running when a new push triggers it again, cancel
# the first instance
concurrency:
  group: "autoupdate-sync"
  cancel-in-progress: true

jobs:
  publish:
    if: github.repository == 'OpenKneeboard/OpenKneeboard'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          path: source
          fetch-depth: 1
        name: Clone source
      - name: Clone dest
        shell: bash
        run: |
          DEST="${{github.workspace}}/dest"
          git clone --depth 1 "https://${{secrets.OPENKNEEBOARD_BOT_PAT}}@github.com/OpenKneeboard/autoupdates.git" "$DEST"
      - name: Sync
        shell: bash
        run:
          rsync --archive --delete --exclude .git --verbose source/autoupdate/ dest/
      - name: Push
        shell: bash
        working-directory: dest
        run: |
          git config user.name "OpenKneeboard Bot"
          git config user.email "bot@openkneeboard.com"
          
          git add .
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update from OpenKneeboard/OpenKneeboard@$GITHUB_SHA"
            git push origin main
          else
            echo "No changes to sync."
          fi
